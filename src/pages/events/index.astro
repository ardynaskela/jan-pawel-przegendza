---
import H1 from "../../components/h1.astro";
import AnimatedLayout from "../../layouts/AnimatedLayout.astro";
import { getCollection } from "astro:content";
import { marked } from "marked";

const items = await getCollection("events");
const sortedItems = items.sort((a: any, b: any) => {
  const dateA = typeof a.data.date === 'string' ? new Date(a.data.date) : a.data.date;
  const dateB = typeof b.data.date === 'string' ? new Date(b.data.date) : b.data.date;
  return dateB.getTime() - dateA.getTime();
});

const years = [...new Set(sortedItems.map((i: any) => {
  const eventDate = typeof i.data.date === 'string' ? new Date(i.data.date) : i.data.date;
  return eventDate.getFullYear();
}))].sort((a: any, b: any) => b - a);

const title = "Events - Jan Paweł Przegendza";
const description = "Events by Jan Paweł Przegendza";
---

<AnimatedLayout title={title} description={description}>
  <H1>Events</H1>
  
  <!-- Year filters -->
  <div class="mt-4 sm:mt-6 flex gap-2 overflow-x-auto pb-2 sm:flex-wrap sm:overflow-x-visible sm:pb-0" id="year-filters">
    <button 
      class="year-filter active px-4 py-2 rounded-full border border-neutral-800 text-neutral-200 text-sm transition-colors hover:bg-neutral-800"
      data-year="all"
    >
      All
    </button>
    {years.map((year: any) => (
      <button 
        class="year-filter px-4 py-2 rounded-full border border-neutral-800 text-neutral-200 text-sm transition-colors hover:bg-neutral-800 flex items-center gap-2"
        data-year={year}
      >
        <span>{year}</span>
      </button>
    ))}
  </div>

  <div class="mt-4 sm:mt-6 flex flex-col gap-6" id="events-container">
    {sortedItems.map((i: any, index: number) => {
      const eventDate = typeof i.data.date === 'string' ? new Date(i.data.date) : i.data.date;
      const descHtml = i.data.description ? marked.parse(i.data.description) : "";
      const year = eventDate.getFullYear();
      
      return (
        <>
          <article class="flex flex-col gap-2 event-item" data-year={year}>
            <h2 class="text-xl lg:text-2xl text-neutral-200 font-medium">
              {i.data.title}
            </h2>
            <time class="text-base lg:text-lg text-neutral-200">
              {eventDate.toLocaleDateString("en-GB", {
                year: "numeric",
                month: "long",
                day: "numeric"
              })}, {eventDate.toLocaleTimeString("en-GB", {
                hour: "2-digit",
                minute: "2-digit"
              })}
            </time>
            {descHtml && (
              <div class="text-base lg:text-lg text-neutral-300 max-w-2xl" set:html={descHtml} />
            )}
          </article>
          {index < sortedItems.length - 1 && (
            <div class="flex justify-start -my-3 sm:-my-4 event-divider" data-index={index}>
              <span class="text-neutral-200 text-2xl">•</span>
            </div>
          )}
        </>
      );
    })}
  </div>
</AnimatedLayout>

<style>
  #year-filters {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  #year-filters::-webkit-scrollbar {
    display: none;
  }

  .year-filter.active {
    background-color: rgb(23 23 23);
  }

.year-filter.active.with-x::after {
  content: '×';
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 0.25rem;
  font-size: 1.4rem;       
  font-weight: 100;        
  transform: translateY(-1px);
}


  .event-item,
  .event-divider {
    display: flex;
  }

  .event-item.hidden,
  .event-divider.hidden {
    display: none;
  }
</style>

<script>
  function initYearFilters() {
    let activeYear = 'all';
    const filterButtons = document.querySelectorAll('.year-filter');
    const eventItems = document.querySelectorAll('.event-item');
    const eventDividers = document.querySelectorAll('.event-divider');

    function updateDisplay() {
      const visibleIndices = new Set();
      
      eventItems.forEach((item, index) => {
        const itemYear = item.getAttribute('data-year');
        if (activeYear === 'all' || itemYear === activeYear) {
          item.classList.remove('hidden');
          visibleIndices.add(index);
        } else {
          item.classList.add('hidden');
        }
      });

      eventDividers.forEach((divider) => {
        const dividerIndex = parseInt(divider.getAttribute('data-index') || '0');
        const nextIndex = dividerIndex + 1;
        
        if (visibleIndices.has(dividerIndex) && visibleIndices.has(nextIndex)) {
          divider.classList.remove('hidden');
        } else {
          divider.classList.add('hidden');
        }
      });
    }

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const year = button.getAttribute('data-year') || 'all';
        
        if (year !== 'all' && activeYear === year) {
          activeYear = 'all';
          filterButtons.forEach(btn => {
            btn.classList.remove('active', 'with-x');
          });
          filterButtons[0].classList.add('active');
        } else {
          activeYear = year;
          filterButtons.forEach(btn => {
            btn.classList.remove('active', 'with-x');
          });
          button.classList.add('active');
          if (year !== 'all') {
            button.classList.add('with-x');
          }
        }
        
        updateDisplay();
      });
    });

    updateDisplay();
  }

  initYearFilters();

  document.addEventListener('astro:page-load', () => {
    initYearFilters();
  });
</script>
