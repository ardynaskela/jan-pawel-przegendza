---
import H1 from "../../components/h1.astro";
import GrainGradientBackground from "../../components/graingradient-background";
import Link from "../../components/link.astro";
import Navigation from "../../components/navigation";
import { NAV_ITEMS } from "../../lib/nav";
import "../../styles/global.css";
import { Font } from "astro:assets";
import { ClientRouter } from "astro:transitions";
import LoadingIndicator from "astro-loading-indicator/component";
import { getCollection } from "astro:content";
import { marked } from "marked";

const items = await getCollection("events");
const sortedItems = items.sort((a: any, b: any) => {
  const dateA = typeof a.data.date === 'string' ? new Date(a.data.date) : a.data.date;
  const dateB = typeof b.data.date === 'string' ? new Date(b.data.date) : b.data.date;
  return dateB.getTime() - dateA.getTime();
});

// Extract unique years
const years = [...new Set(sortedItems.map((i: any) => {
  const eventDate = typeof i.data.date === 'string' ? new Date(i.data.date) : i.data.date;
  return eventDate.getFullYear();
}))].sort((a: any, b: any) => b - a);

const title = "Events - Jan Paweł Przegendza";
const description = "Events by Jan Paweł Przegendza";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />

    <Font cssVariable="--font-geist" preload />
    <ClientRouter />
    <LoadingIndicator color="#f4f4f5" height="2px" />
  </head>

  <body class="font-sans min-h-screen bg-neutral-950">
    <main class="relative min-h-screen">
      <!-- ANIMATED BACKGROUND STRIP (FIXED LEFT SIDE) -->
      <div class="fixed top-0 left-0 w-[24px] lg:w-[520px] h-screen z-0">
        <div class="relative w-full h-full">
          <!-- Mobile version with adjusted parameters -->
          <div class="lg:hidden w-full h-full">
            <GrainGradientBackground
              client:only="react"
              width={1280}
              height={720}
              colors={["#ffcca8", "#08062d", "#000000"]}
              colorBack="#020209"
              softness={1}
              intensity={0.69}
              noise={0.5}
              shape="ripple"
              speed={1.48}
              scale={15}
              offsetX={2}
              offsetY={5}
              style={{ width: "100%", height: "100%" }}
            />
          </div>
          
          <!-- Desktop version with original parameters -->
          <div class="hidden lg:block w-full h-full">
            <GrainGradientBackground
              client:only="react"
              width={1280}
              height={720}
              colors={["#ffcca8", "#08062d", "#000000"]}
              colorBack="#020209"
              softness={1}
              intensity={0.69}
              noise={0.5}
              shape="ripple"
              speed={1.48}
              scale={2.36}
              offsetX={-1}
              offsetY={-0.82}
              style={{ width: "100%", height: "100%" }}
            />
          </div>
        </div>
      </div>

      <section class="pr-4 sm:pr-12 pb-24">
        <div class="min-h-screen grid gap-6 lg:gap-12 grid-cols-[24px_1fr] lg:grid-cols-[minmax(0,520px)_1fr] items-start">
          <!-- SPACER FOR ANIMATION (LEFT SIDE) -->
          <div></div>

          <!-- CONTENT (RIGHT SIDE) -->
          <div class="min-w-0 pt-4 sm:pt-8 pl-0 sm:pl-0">
            <H1>Events</H1>
            
            <!-- Year filters -->
            <div class="mt-4 sm:mt-6 flex gap-2 overflow-x-auto pb-2 sm:flex-wrap sm:overflow-x-visible sm:pb-0" id="year-filters">
              <button 
                class="year-filter active px-4 py-2 rounded-full border border-neutral-800 text-neutral-200 text-sm transition-colors hover:bg-neutral-800"
                data-year="all"
              >
                All
              </button>
              {years.map((year: any) => (
                <button 
                  class="year-filter px-4 py-2 rounded-full border border-neutral-800 text-neutral-200 text-sm transition-colors hover:bg-neutral-800 flex items-center gap-2"
                  data-year={year}
                >
                  <span>{year}</span>
                </button>
              ))}
            </div>

            <div class="mt-4 sm:mt-6 flex flex-col gap-6" id="events-container">
              {sortedItems.map((i: any, index: number) => {
                const eventDate = typeof i.data.date === 'string' ? new Date(i.data.date) : i.data.date;
                const descHtml = i.data.description ? marked.parse(i.data.description) : "";
                const year = eventDate.getFullYear();
                
                return (
                  <>
                    <article class="flex flex-col gap-2 event-item" data-year={year}>
                      <h2 class="text-xl lg:text-2xl text-neutral-200 font-medium">
                        {i.data.title}
                      </h2>
                      <time class="text-base lg:text-lg text-neutral-200">
                        {eventDate.toLocaleDateString("en-GB", {
                          year: "numeric",
                          month: "long",
                          day: "numeric"
                        })}, {eventDate.toLocaleTimeString("en-GB", {
                          hour: "2-digit",
                          minute: "2-digit"
                        })}
                      </time>
                      {descHtml && (
                        <div class="text-base lg:text-lg text-neutral-300 max-w-2xl" set:html={descHtml} />
                      )}
                    </article>
                    {index < sortedItems.length - 1 && (
                      <div class="flex justify-start -my-3 sm:-my-4 event-divider" data-index={index}>
                        <span class="text-neutral-200 text-2xl">•</span>
                      </div>
                    )}
                  </>
                );
              })}
            </div>
          </div>
        </div>
      </section>
      
      <!-- FOOTER (FIXED AT BOTTOM, ONLY IN RIGHT AREA) -->
      <footer class="fixed bottom-0 z-40 pr-4 py-0 md:py-4 bg-transparent md:bg-neutral-950" style="left: calc(24px + 2.5rem); right: 0;">
        <div class="flex justify-end">
          <!-- Desktop -->
          <div class="hidden md:flex items-center gap-4 flex-wrap justify-end">
            {NAV_ITEMS.map((item: any) => (
              <Link href={item.href} variant="secondary">
                {item.label}
              </Link>
            ))}
          </div>

          <!-- Mobile -->
          <div class="md:hidden">
            <Navigation client:load items={NAV_ITEMS} />
          </div>
        </div>
      </footer>
    </main>
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
  
  @media (min-width: 1024px) {
    footer {
      left: calc(520px + 3rem) !important;
    }
  }

  .year-filter.active {
    background-color: rgb(23 23 23);
  }

  .year-filter.active.with-x::after {
    content: '×';
    margin-left: 0.25rem;
    font-size: 1.25rem;
    line-height: 1;
  }

  .event-item,
  .event-divider {
    display: flex;
  }

  .event-item.hidden,
  .event-divider.hidden {
    display: none;
  }
</style>

<script>
  function initYearFilters() {
    let activeYear = 'all';
    const filterButtons = document.querySelectorAll('.year-filter');
    const eventItems = document.querySelectorAll('.event-item');
    const eventDividers = document.querySelectorAll('.event-divider');

    function updateDisplay() {
      const visibleIndices = new Set();
      
      eventItems.forEach((item, index) => {
        const itemYear = item.getAttribute('data-year');
        if (activeYear === 'all' || itemYear === activeYear) {
          item.classList.remove('hidden');
          visibleIndices.add(index);
        } else {
          item.classList.add('hidden');
        }
      });

      eventDividers.forEach((divider) => {
        const dividerIndex = parseInt(divider.getAttribute('data-index') || '0');
        const nextIndex = dividerIndex + 1;
        
        if (visibleIndices.has(dividerIndex) && visibleIndices.has(nextIndex)) {
          divider.classList.remove('hidden');
        } else {
          divider.classList.add('hidden');
        }
      });
    }

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const year = button.getAttribute('data-year') || 'all';
        
        if (year !== 'all' && activeYear === year) {
          activeYear = 'all';
          filterButtons.forEach(btn => {
            btn.classList.remove('active', 'with-x');
          });
          filterButtons[0].classList.add('active');
        } else {
          activeYear = year;
          filterButtons.forEach(btn => {
            btn.classList.remove('active', 'with-x');
          });
          button.classList.add('active');
          if (year !== 'all') {
            button.classList.add('with-x');
          }
        }
        
        updateDisplay();
      });
    });

    updateDisplay();
  }

  initYearFilters();

  document.addEventListener('astro:page-load', () => {
    initYearFilters();
  });
</script>
